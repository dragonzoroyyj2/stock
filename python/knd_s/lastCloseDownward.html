<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRX 연속 하락 종목 조회</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .content-container { padding: 1rem; box-sizing: border-box; }
        .search-row { display: flex; flex-wrap: wrap; gap:0.5rem; margin-bottom:0.5rem; align-items:center; }
        .search-row label { margin-right:0.3rem; font-weight:600; }
        .search-row input[type=date], .search-row input[type=number], .search-row select, .search-row button {
          padding:0.45rem 0.7rem; border-radius:6px; border:1px solid #ccc; flex-shrink:0; box-sizing:border-box;
        }
        .search-row input[type=date] { width:120px; min-width:80px; }
        .search-row input[type=number] { width:60px; min-width:50px; }
        .search-row button { cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.3rem; }
        .search-row button.blue { background-color: #2563eb; color: #fff; border: 1px solid #2563eb; }

        .table-container { padding-left:0; padding-right:0; margin-top:1rem; overflow-x:auto; }
        table { width:100%; border-collapse:collapse; margin:0; }
        #resultTable tbody tr { border-bottom:1px solid #d1d5db; cursor:pointer; }
        #resultTable tbody tr:nth-child(even){ background-color: #f2f2f2; }
        #resultTable tbody tr:hover { background-color: #ddd; }
        #resultTable thead th, #resultTable tbody td { padding: 8px; border: 1px solid #ddd; text-align: left; }

        .warning { color: red; margin-top: 10px; font-weight: bold; }

        /* 로딩 오버레이 */
        #overlayLoading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
        #overlayLoading .loading-box { background:#fff; padding:1rem 2rem; border-radius:8px; text-align:center; box-shadow:0 0 10px rgba(0,0,0,0.2); }
        #overlayLoading .loading-icon { font-size:2rem; margin-bottom:0.5rem; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
        #overlayLoading button { margin-top:0.5rem; padding:0.5rem 1rem; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; }
        #overlayLoading button:disabled { background:#999; cursor:default; }

        /* 차트 팝업 오버레이 */
        #chartPopup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; }
        #chartPopup .popup-content { background: #fff; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow: auto; position: relative; }
        #chartPopup .chart-close-btn { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; cursor: pointer; }
        #chartPopup img { max-width: 100%; height: auto; display: block; }
        
        /* 차트 로딩 */
        #chartLoading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; font-size: 1.2em; color: #555; z-index: 101; }
    </style>
</head>
<>

	<div layout:fragment="content">
	    <div class="content-container">
	        <h1>KRX 연속 하락 종목 조회</h1>

	        <div class="search-row">
	            <label for="rangeSelect">기간 선택:</label>
	            <select id="rangeSelect">
	                <option value="90">3개월</option>
	                <option value="180">6개월</option>
	                <option value="365">1년</option>
	                <option value="730">2년</option>
	            </select>
	            <label for="start">시작일:</label>
	            <input type="date" id="start" required>
	            <label for="end">종료일:</label>
	            <input type="date" id="end" required>
	            <label for="nStocks">상위 N개:</label>
	            <input type="number" id="nStocks" value="10" min="1" max="50">
	            <button id="searchBtn" class="blue">분석 시작</button>
	        </div>

	        <div id="warning" class="warning"></div>

	        <div class="table-container">
	            <h2>분석 결과</h2>
	            <table id="resultTable">
	                <thead>
	                    <tr>
	                        <th>종목 코드</th>
	                        <th>종목명</th>
	                    </tr>
	                </thead>
	                <tbody id="resultTableBody">
	                </tbody>
	            </table>
	        </div>
	    </div>

	    <!-- 로딩 오버레이 -->
	    <div id="overlayLoading">
	        <div class="loading-box">
	            <div class="loading-icon">&#x231B;</div>
	            <p>분석 작업 진행 중...</p>
	            <button id="cancelLoadingBtn">취소</button>
	        </div>
	    </div>

	    <!-- 차트 팝업 -->
	    <div id="chartPopup" class="overlay">
	        <div class="overlay-content popup-content">
	            <button data-close="chartPopup" class="chart-close-btn">&times;</button>
	            <div id="chartLoading" class="chart-loading">
	                차트 로딩 중...
	            </div>
	            <img id="chartImage" src="" alt="차트 이미지">
	        </div>
	    </div>
	</div>	
	
	    <th:block layout:fragment="pageScript">
	        <script>
	        document.addEventListener("DOMContentLoaded", () => {
	            const startInput = document.getElementById("start");
	            const endInput = document.getElementById("end");
	            const nStocksInput = document.getElementById("nStocks");
	            const searchBtn = document.getElementById("searchBtn");
	            const warning = document.getElementById("warning");
	            const resultTableBody = document.getElementById("resultTableBody");
	            const chartPopup = document.getElementById("chartPopup");
	            const chartImage = document.getElementById("chartImage");
	            const overlayLoading = document.getElementById("overlayLoading");
	            const cancelLoadingBtn = document.getElementById("cancelLoadingBtn");
	            const rangeSelect = document.getElementById("rangeSelect");
	            const chartLoading = document.getElementById("chartLoading");

	            let pollingInterval;
	            let taskId;
	            
	            const today = new Date();
	            function setStartEnd(daysAgo){
	                if (startInput) {
	                    const start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - daysAgo);
	                    startInput.value = start.toISOString().substring(0,10);
	                }
	                if (endInput) {
	                    endInput.value = today.toISOString().substring(0,10);
	                }
	            }

	            if (rangeSelect) {
	                setStartEnd(parseInt(rangeSelect.value));
	                rangeSelect.addEventListener("change", () => { setStartEnd(parseInt(rangeSelect.value)); });
	            }

	            // 작업 상태 폴링 함수 (Promise 반환)
	            function pollTaskStatus(taskId) {
	                return new Promise((resolve, reject) => {
	                    pollingInterval = setInterval(async () => {
	                        try {
	                            const res = await fetch(`/api/krx/task/status?taskId=${taskId}`);
	                            if (!res.ok) {
	                                throw new Error("서버에서 상태 정보를 가져오는 중 오류가 발생했습니다.");
	                            }
	                            const data = await res.json();
	                            if (data.status === "COMPLETED") {
	                                clearInterval(pollingInterval);
	                                resolve(data.result);
	                            } else if (data.status === "FAILED") {
	                                clearInterval(pollingInterval);
	                                reject(new Error(data.error));
	                            }
	                        } catch (err) {
	                            clearInterval(pollingInterval);
	                            reject(err);
	                        }
	                    }, 2000); // 2초마다 폴링
	                });
	            }

	            searchBtn.addEventListener("click", async () => {
	                const start = startInput.value;
	                const end = endInput.value;
	                const nStocks = nStocksInput.value;

	                if (!start || !end) {
	                    warning.textContent = "⚠️ 시작일과 종료일을 모두 입력해주세요.";
	                    return;
	                }

	                if (pollingInterval) clearInterval(pollingInterval);
	                
	                overlayLoading.style.display = "flex";
	                warning.textContent = "";
	                resultTableBody.innerHTML = "";
	                
	                try {
	                    const res = await fetch(`/api/krx/last-close-downward/request?start=${start}&end=${end}&topN=${nStocks}`);
	                    if (res.status === 409) { // CONFLICT 상태 코드 처리
	                        const errorData = await res.json();
	                        throw new Error(errorData.error);
	                    }
	                    if (!res.ok) {
	                        const errorData = await res.json();
	                        throw new Error(errorData.error);
	                    }
	                    const data = await res.json();
	                    taskId = data.taskId;
	                    
	                    const resultData = await pollTaskStatus(taskId);
	                    
	                    overlayLoading.style.display = "none";
	                    if (!resultData || !Array.isArray(resultData)) {
	                        warning.textContent = "분석 실패 (응답 데이터 오류)";
	                        return;
	                    }
	                    resultTableBody.innerHTML = '';
	                    resultData.forEach(item => {
	                        const tr = document.createElement("tr");
	                        tr.innerHTML = `<td>${item.ticker || ""}</td><td>${item.name || ""}</td>`;
	                        tr.addEventListener("click", async () => {
	                            chartPopup.style.display = "flex";
	                            chartImage.src = "";
	                            chartImage.alt = "차트 불러오는 중...";
	                            chartLoading.style.display = "flex"; // 차트 로딩 표시

	                            try {
	                                const chartRes = await fetch(`/api/krx/last-close-downward/chart/request?baseSymbol=${item.ticker}&start=${start}&end=${end}`);
	                                if (chartRes.status === 409) {
	                                    const errorData = await chartRes.json();
	                                    throw new Error(errorData.error);
	                                }
	                                if (!chartRes.ok) {
	                                    const errorData = await chartRes.json();
	                                    throw new Error(errorData.error);
	                                }
	                                const chartTaskData = await chartRes.json();

	                                const chartResult = await pollTaskStatus(chartTaskData.taskId);
	                                
	                                chartLoading.style.display = "none"; // 차트 로딩 숨김
	                                if (chartResult && chartResult.error) {
	                                    chartImage.alt = chartResult.error;
	                                } else if (chartResult && chartResult.image_data) {
	                                    chartImage.src = `data:image/png;base64,${chartResult.image_data}`;
	                                } else {
	                                    chartImage.alt = "차트 데이터를 불러오지 못했습니다.";
	                                }
	                            } catch (err) {
	                                chartLoading.style.display = "none"; // 차트 로딩 숨김
	                                chartImage.alt = "차트 로딩 오류: " + err.message;
	                                console.error(err);
	                            }
	                        });
	                        resultTableBody.appendChild(tr);
	                    });
	                } catch (err) {
	                    overlayLoading.style.display = "none";
	                    console.error(err);
	                    warning.textContent = "⚠️ " + err.message;
	                }
	            });

	            document.querySelectorAll("[data-close]").forEach(btn => {
	                btn.addEventListener("click", e => {
	                    document.getElementById(e.target.dataset.close).style.display = "none";
	                    if (chartImage) {
	                        chartImage.src = ""; // 팝업 닫을 때 이미지 초기화
	                        chartImage.alt = "";
	                    }
	                });
	            });

	            cancelLoadingBtn.addEventListener("click", () => {
	                if (pollingInterval) clearInterval(pollingInterval);
	                overlayLoading.style.display = "none";
	                warning.textContent = "⚠️ 분석이 취소되었습니다.";
	            });
	        });
	        </script>
	    </th:block>
</body>
</html>
