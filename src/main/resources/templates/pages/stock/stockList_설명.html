<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>주식 종목 리스트</title>

  <!-- Font Awesome은 default_layout에서 이미 포함 -->
  <!-- 공용 CSS는 default_layout에서 이미 포함 -->
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 주식 종목 리스트</h2>

    <!-- 검색 라인 -->
    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="검색어 입력" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
        <button class="btn"><i class="fas fa-filter"></i></button>
        <button class="btn"><i class="fas fa-sync-alt"></i></button>
      </div>
    </div>

    <!-- 총건 + 기능 버튼 -->
    <div class="list-info">
      <span id="totalCount">총 0건</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel" title="엑셀 다운로드"><i class="fa-solid fa-file-excel"></i></button>
        <button id="addBtn" class="btn" title="추가"><i class="fas fa-plus"></i></button>
        <button id="deleteSelectedBtn" class="btn red" title="삭제"><i class="fas fa-trash"></i></button>
      </div>
    </div>

    <!-- 테이블 -->
    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" /></th>
          <th>No</th>
          <th>종목코드</th>
          <th>회사명</th>
          <th>시장구분</th>
          <th>업종</th>
          <th>종가</th>
          <th>시가</th>
          <th>고가</th>
          <th>저가</th>
          <th>거래량</th>
          <th>기준일</th>
        </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <!-- 페이징 -->
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- 등록 모달 -->
  <div id="addModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>서버 등록</h3>
        <span data-close="addModal" class="close-btn">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="form-group"><label>제목</label><input id="titleInput" /></div>
        <div class="form-group"><label>담당자</label><input id="ownerInput" /></div>
        <div class="form-group"><label>서버 종류</label>
          <select id="serverType"><option>웹 서버</option><option>DB 서버</option><option>API 서버</option></select>
        </div>
        <div class="form-group"><label>운영 상태</label>
          <div class="option-group">
            <label><input type="radio" name="status" value="active" checked>운영</label>
            <label><input type="radio" name="status" value="pause">중지</label>
          </div>
        </div>
        <div class="form-group"><label>기능 옵션</label>
          <div class="option-group">
            <label><input type="checkbox">백업 활성화</label>
            <label><input type="checkbox">자동 모니터링</label>
          </div>
        </div>
        <div class="form-group"><label>등록일</label><input type="date" id="regDateInput" /></div>
        <div class="form-group"><label>비고</label><textarea id="noteInput" rows="3"></textarea></div>
      </div>
      <div class="modal-footer elegant-footer">
        <button id="saveBtn" class="btn">저장</button>
        <button class="btn gray" data-close="addModal">닫기</button>
      </div>
    </div>
  </div>

  <!-- 상세 / 수정 모달 -->
  <div id="detailModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>상세 정보</h3>
        <span data-close="detailModal" class="close-btn">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="form-group"><label>No</label><input id="detailId" readonly /></div>
        <div class="form-group"><label>제목</label><input id="detailTitle" /></div>
        <div class="form-group"><label>담당자</label><input id="detailOwner" /></div>
        <div class="form-group"><label>등록일</label><input id="detailRegDate" readonly /></div>
        <div class="form-group"><label>서버 상태</label>
          <select><option>정상</option><option>점검중</option></select>
        </div>
        <div class="form-group"><label>기능 옵션</label>
          <div class="option-group">
            <label><input type="checkbox">백업 활성화</label>
            <label><input type="checkbox">자동 모니터링</label>
          </div>
        </div>
        <div class="form-group"><label>비고</label><textarea id="detailNote" rows="3"></textarea></div>
      </div>
      <div class="modal-footer elegant-footer">
        <button id="updateBtn" class="btn">수정</button>
        <button class="btn gray" data-close="detailModal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 페이지별 초기화 -->
<th:block layout:fragment="pageScript">

  <script src="/js/commonPagination_op.js"></script>
  <script src="/js/commonUnifiedList_op.js"></script>

 
  
  <script>
     document.addEventListener("DOMContentLoaded", () => {
       function getPageGroupSize() {
         const width = window.innerWidth;
         if (width < 480) return 3;
         if (width < 768) return 5;
         if (width < 1024) return 10;
         return 20;
       }

       let pageGroupSize = getPageGroupSize();

       // ================================
       // 공용 리스트 초기화
       // ================================
       const unifiedListManager = initUnifiedList({
         mode: "server",
         pagination: true,
         apiUrl: "/api/stock/list",
         tableBodySelector: "#dataTable",
         paginationSelector: "#pagination",
         searchInputSelector: "#searchInput",
         searchBtnSelector: "#searchBtn",
         addBtnSelector: "#addBtn",
         deleteSelectedBtnSelector: "#deleteSelectedBtn",
         excelBtnSelector: "#excelBtn",
         columns: [
             { key: "id", label: "No" },
             { key: "Code", label: "종목코드"},
             { key: "Name", label: "회사명" , isDetailLink: true },
             { key: "Market", label: "시장구분" },
             { key: "Dept", label: "업종" },
             { key: "Close", label: "종가" },
             { key: "Open", label: "시가" },
             { key: "High", label: "고가" },
             { key: "Low", label: "저가" },
             { key: "Volume", label: "거래량" },
             { key: "Date", label: "기준일" }
         ],
         pageSize: 10,
         pageGroupSize: pageGroupSize,
         buttons: {
           search: true,
           searchInput: true,
           add: true,
           deleteSelected: true,
           excel: true
         },
		 enableRowClickDetail: false, // 행 전체 클릭으로 상세 보기 활성화
		 // 상세보기만 가능하고, 수정/삭제 버튼 비활성화
		 enableDetailView: true,
		 detailViewButtons: {
		   update: false,
		   delete: false,
		 }
		 /*
		 
		 1. 모듈화 및 재사용성 향상
		 현재 코드는 UnifiedList 클래스 하나에 모든 기능이 포함되어 있습니다. 이를 모듈화하여 더 유연하고 유지보수하기 쉽게 만들 수 있습니다. 
		 UI/피드백 로직 분리: showSpinner(), hideSpinner(), notify()와 같은 UI 관련 로직을 별도의 ui.js 또는 feedback.js 파일로 분리합니다. 이렇게 하면 UI 피드백 기능을 재사용하거나 다른 UI 라이브러리로 교체하기 쉬워집니다.
		 API 호출 로직 분리: fetchOptions()와 같은 API 관련 로직을 api.js 파일로 분리하여 관리합니다. API 엔드포인트나 인증 방식이 변경될 때 더 쉽게 대응할 수 있습니다.
		 ES 모듈(ESM) 사용: 현재 코드는 즉시 실행되는 스크립트 형태로 구성되어 있습니다. import와 export를 사용한 ES 모듈 방식으로 전환하면 의존성 관리가 명확해지고 코드의 재사용성이 높아집니다. 
		 2. 성능 최적화
		 Intersection Observer를 이용한 무한 스크롤(Infinite Scroll): 페이징 방식 외에 사용자가 스크롤을 내릴 때 자동으로 다음 페이지를 불러오는 무한 스크롤 기능을 추가할 수 있습니다. 이는 사용자 경험을 향상하고, 초기 페이지 로딩 시간을 줄이는 데 도움이 됩니다.
		 가상화(Virtualization) 또는 윈도잉(Windowing): 목록의 항목 수가 매우 많아지면 모든 DOM 요소를 렌더링하는 데 시간이 오래 걸립니다. 화면에 보이는 요소만 렌더링하는 가상화 기법을 적용하면 성능을 크게 향상할 수 있습니다.
		 디바운스(Debounce) 또는 스로틀(Throttle) 적용: 검색창에 타이핑할 때마다 API를 호출하는 대신, 일정 시간 동안 입력이 없을 때만 호출하는 디바운스를 적용하여 불필요한 API 요청을 줄일 수 있습니다. 
		 3. 기능 확장 및 유연성 강화 
		 사용자 정의 템플릿 지원: renderTable() 메서드는 현재 하드코딩된 HTML 구조를 사용합니다. 나중에는 사용자가 테이블 행의 템플릿을 직접 정의할 수 있도록 콜백 함수나 템플릿 문자열을 인자로 받는 기능을 추가할 수 있습니다.
		 필터링 기능 개선: 현재는 단일 검색어로만 필터링을 지원합니다. 추후에는 여러 필드를 조합하거나 드롭다운 메뉴를 이용하는 등 고급 필터링 기능을 추가할 수 있습니다.
		 상태 관리 로직 개선: UnifiedList 클래스가 currentPage나 currentSort와 같은 상태를 직접 관리하고 있습니다. 만약 애플리케이션의 규모가 커지면 전용 상태 관리 라이브러리(예: Redux, Vuex)와 통합하여 더 체계적으로 상태를 관리할 수 있습니다.
		 확장 가능한 이벤트 시스템: 현재는 click이나 keydown과 같은 기본 DOM 이벤트에 의존합니다. 커스텀 이벤트를 만들고, 이를 구독하고 발행하는 메커니즘을 도입하면 클래스 간의 결합도를 낮추고 유연성을 높일 수 있습니다.
		 4. 안정성 및 유지보수성
		 테스트 자동화: Jest나 Mocha와 같은 테스트 프레임워크를 도입하여 유닛 테스트와 통합 테스트를 작성합니다. 테스트 코드는 새로운 기능을 추가하거나 기존 코드를 리팩토링할 때 발생할 수 있는 버그를 미리 방지하는 데 필수적입니다.
		 타입스크립트(TypeScript) 도입: 자바스크립트에 타입을 추가하여 코드의 안정성을 높입니다. 타입스크립트는 개발 과정에서 잠재적인 오류를 미리 발견하고, 코드의 가독성을 향상하여 협업을 용이하게 합니다.
		 접근성(Accessibility) 강화: 키보드 내비게이션, 스크린 리더 지원 등 웹 접근성(ARIA) 표준을 준수하도록 코드를 개선하면 더 많은 사용자가 애플리케이션을 편리하게 이용할 수 있습니다. 
		 
		 
		 ===================================================================
		 
		 최종 결과물에 대한 설명
		 이번 작업은 commonUnifiedList_op.js와 top.html 코드를 개선하여 다음과 같은 목표를 달성했습니다.
		 UI/UX 개선: 로딩 스피너와 토스트 알림을 추가하여 사용자에게 더 직관적인 피드백을 제공합니다.
		 안정성 향상: CSRF 토큰 처리를 안정화하고, initUnifiedList의 config 유효성 검사 로직을 추가했습니다.
		 유연성 강화: 역할 기반 권한 제어, 확장 가능한 CRUD 콜백, 테이블 정렬, 행 클릭 시 상세 조회 등의 기능을 추가하여 다양한 페이지 요구사항에 유연하게 대응하도록 만들었습니다.
		 기능 복구 및 통합: 기존에 제공되던 top.html의 세션 및 프로필 관련 기능을 모두 복구하고, 새로운 UX 기능들과 통합했습니다.
		 아래는 각 파일에 적용된 주요 변경사항 및 기능에 대한 상세 설명입니다.
		 1.commonUnifiedList_op.js
		 이 파일은 공용 리스트 관리 기능을 확장하여 더욱 강력하고 유연하게 만들었습니다.
		 로딩 스피너 & 토스트 알림 통합: showSpinner(), hideSpinner(), notify() 메서드가 추가되었습니다. 이제 loadList()나 CRUD 작업이 시작될 때 로딩 스피너가 나타나고, 작업 완료나 실패 시 토스트 알림이 표시됩니다.
		 config 유효성 검사: constructor에 validateConfig() 메서드가 추가되어, 필수 속성이 누락되거나 타입이 맞지 않을 경우 명확한 오류 메시지를 발생시켜 개발 편의성을 높였습니다.
		 역할 기반 권한 제어: config.buttons에 roles 속성을 추가하여, 사용자 역할에 따라 버튼의 가시성을 동적으로 제어할 수 있습니다.
		 CRUD 콜백 기능: onSaveSuccess, onUpdateSuccess, onDeleteSuccess, onAddModalOpen, onDetailModalOpen 등 다양한 콜백 함수를 config에 추가하여, 각 작업이 완료될 때 페이지별 커스텀 로직을 실행할 수 있습니다.
		 테이블 정렬 기능: sortable 클래스와 data-sort-key 속성을 가진 테이블 헤더 클릭 시 데이터를 정렬하는 기능이 추가되었습니다. 서버 모드에서는 정렬 파라미터를 API에 전달하고, 클라이언트 모드에서는 자체적으로 정렬을 수행합니다.
		 행 클릭 상세 조회: enableRowClickDetail: true 설정 시, 테이블 행 전체를 클릭하여 상세 모달을 띄우는 기능이 추가되었습니다.
		 안정적인 CSRF 토큰 처리: fetchOptions에서 <meta> 태그를 이용해 CSRF 토큰을 안전하게 가져오도록 변경되었습니다.
		 2.top.html
		 상단바와 관련된 기존 기능을 복구하고, 새로운 UX 개선 요소를 통합하여 더 안정적이고 사용자 친화적으로 만들었습니다.
		 CSRF 토큰 처리: th:inline="javascript"를 사용하여 _csrf 객체가 존재하지 않을 경우를 대비한 안전한 토큰 주입 로직을 적용했습니다. 이는 로그인하지 않은 상태에서 발생할 수 있는 템플릿 오류를 방지합니다.
		 로딩 스피너 및 토스트 알림 컴포넌트: fragments/top.html에 로딩 스피너와 토스트 메시지를 위한 HTML 및 CSS가 추가되었습니다. commonUnifiedList_op.js의 notify() 함수와 함께 작동합니다.
		 기존 기능 복구: 세션 타이머, 세션 연장, 프로필 조회/수정(자리만 마련), 로그아웃 등 이전에 존재했던 모든 기능이 정상적으로 동작하도록 코드를 재통합했습니다.
		 사이드바 토글 연동: menuToggle 버튼 클릭 시 default_layout.html의 window.toggleSidebar 함수를 호출하도록 코드를 추가하여, 사이드바와 상단바의 연동 기능을 복구했습니다.
		 최종 결과물 사용 방법
		 default_layout.html: 기존과 동일하게 사용하되, head에 CSRF 토큰 메타 태그가 없으므로 신경 쓸 필요가 없습니다.
		 fragments/top.html: 제공된 최종 코드를 복사하여 덮어쓰기 합니다.
		 commonUnifiedList_op.js: 제공된 최종 코드를 복사하여 덮어쓰기 합니다.
		 페이지별 스크립트: initUnifiedList 호출 시, 필요에 따라 enableDetailView, enableRowClickDetail, detailViewButtons, buttons, onSaveSuccess 등 새로운 config 옵션들을 활용하여 페이지를 커스터마이징합니다.
		 */
		 // ================================
		 // 이 화면에 특화된 기능 추가
		 // 페이지별로 추가 로직이 필요할 때 직접 addEventListener를 사용하여 기능을 확장
		 // ================================
		 /*
		 관심사 분리 (Separation of Concerns):
		 commonUnifiedList_op.js는 공통 기능(리스트 조회, CRUD, 페이징 등)에만 집중합니다.
		 페이지별 스크립트는 해당 페이지에만 필요한 추가 로직을 담당합니다.
		 이렇게 하면 공통 스크립트가 불필요하게 복잡해지지 않고, 유지보수가 쉬워집니다.
		 유연성:
		 모든 페이지에서 같은 commonUnifiedList_op.js 파일을 사용하면서도, 각 페이지의 요구사항에 맞춰 기능을 자유롭게 추가하거나 변경할 수 있습니다.
		 예를 들어, 어떤 페이지는 추가 버튼이 일반적인 등록 모달을 열지만, 다른 페이지는 사용자 입력이 필요한 커스텀 팝업을 띄울 수 있습니다.
		 코드 충돌 방지:
		 공통 로직과 페이지별 로직이 분리되어 있어, 공통 스크립트를 수정하더라도 특정 페이지의 커스텀 로직에 영향을 주지 않습니다.
		 commonUnifiedList_op.js에서 이벤트 위임을 사용하기 때문에, 페이지별로 추가하는 addEventListener가 공통 로직과 충돌할 가능성이 낮습니다. 
		*/
		
		/*
		 const addUserBtn = document.getElementById("addUserBtn");
		 if (addUserBtn) {
		   addUserBtn.addEventListener("click", () => {
		     alert("사용자 추가 모달을 여는 커스텀 로직");
		     // 사용자 추가 로직 (예: 별도의 API 호출, 특정 폼 초기화 등)
		   });
		 }

		 const customFilterBtn = document.getElementById("customFilterBtn");
		 if (customFilterBtn) {
		   customFilterBtn.addEventListener("click", () => {
		     alert("커스텀 필터링 로직 실행");
		     // 필터링 로직 구현 (예: 특정 파라미터를 추가하여 loadList 호출)
		   });
		 }
		 */

		 // unifiedListManager 객체를 활용하여 공통 기능에 접근 가능
		 // console.log(unifiedListManager.currentPage);
		 
       });
	   
	   
	   // unifiedListManager 객체를 활용하여 공통 기능에 접근 가능
	   console.log(unifiedListManager.currentPage);
	   
       // ================================
       // 화면 리사이즈 시 페이지 그룹 재조정
       // ================================
       window.addEventListener("resize", () => {
         const newGroupSize = getPageGroupSize();
         if (newGroupSize !== pageGroupSize) {
           pageGroupSize = newGroupSize;
           unifiedListManager.pageGroupSize = newGroupSize;
           const event = new Event("resizePagination");
           document.dispatchEvent(event);
         }
       });
     });
   </script>
  
  
</th:block>

</body>
</html>

