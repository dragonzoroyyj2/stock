<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š ì—°ì† í•˜ë½ ì¢…ëª© ì¡°íšŒ</title>
  <style>
    .content-container { padding: 1rem; box-sizing: border-box; }
    .search-row { display: flex; flex-wrap: wrap; gap:0.5rem; margin-bottom:0.5rem; align-items:center; }
    .search-row label { margin-right:0.3rem; font-weight:600; }
    .search-row input[type=date], .search-row input[type=number], .search-row select, .search-row button {
      padding:0.45rem 0.7rem; border-radius:6px; border:1px solid #ccc; flex-shrink:0; box-sizing:border-box;
    }
    .search-row input[type=date] { width:120px; min-width:80px; }
    .search-row input[type=number] { width:60px; min-width:50px; }
    .search-row button { cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.3rem; }

    .table-container { padding-left:0; padding-right:0; margin-top:1rem; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; margin:0; }
    #resultTable tbody tr { border-bottom:1px solid #d1d5db; cursor:pointer; }

    #overlayLoading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
    #overlayLoading .loading-box { background:#fff; padding:1rem 2rem; border-radius:8px; text-align:center; box-shadow:0 0 10px rgba(0,0,0,0.2); }
    #overlayLoading .loading-icon { font-size:2rem; margin-bottom:0.5rem; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    #overlayLoading button { margin-top:0.5rem; padding:0.5rem 1rem; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; }
    #overlayLoading button:disabled { background:#999; cursor:default; }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ì—°ì† í•˜ë½ ì¢…ëª© ì¡°íšŒ</h2>

    <!-- ê²€ìƒ‰ í•„ë“œ -->
    <div class="search-row">
      <label for="start">ì‹œì‘ì¼</label>
      <input type="date" id="start">
      <label for="end">ì¢…ë£Œì¼</label>
      <input type="date" id="end">
      <label for="rangeSelect">ê¸°ê°„</label>
      <select id="rangeSelect">
        <option value="7">1ì£¼ì¼</option>
        <option value="30" selected>1ê°œì›”</option>
        <option value="60">2ê°œì›”</option>
        <option value="90">3ê°œì›”</option>
        <option value="180">6ê°œì›”</option>
        <option value="365">1ë…„</option>
      </select>
      <label for="nStocks">ìƒìœ„ N</label>
      <input type="number" id="nStocks" placeholder="10" value="10" max="999">
      <button id="searchBtn"><i class="fas fa-chart-line"></i><span> ë¶„ì„</span></button>
    </div>

    <div id="warning" style="color:red;font-weight:600;margin-bottom:0.5rem;"></div>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <div class="table-container">
      <table id="resultTable">
        <thead>
          <tr>
            <th>ì¢…ëª© ì½”ë“œ</th>
            <th>ì¢…ëª©ëª…</th>
          </tr>
        </thead>
        <tbody id="resultTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ì°¨íŠ¸ íŒì—… -->
  <div class="modal" id="chartPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>ì¢…ëª© ì°¨íŠ¸</h3>
        <span class="close-btn" data-close="chartPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <img id="chartImage" src="" alt="ì°¨íŠ¸ ì´ë¯¸ì§€" style="max-width:100%;border-radius:8px;">
      </div>
    </div>
  </div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="overlayLoading">
    <div class="loading-box">
      <div class="loading-icon"><i class="fas fa-spinner"></i></div>
      <div>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
      <button id="cancelLoadingBtn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", () => {
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const nStocksInput = document.getElementById("nStocks");
  const searchBtn = document.getElementById("searchBtn");
  const warning = document.getElementById("warning");
  const resultTableBody = document.getElementById("resultTableBody");
  const chartPopup = document.getElementById("chartPopup");
  const chartImage = document.getElementById("chartImage");
  const overlayLoading = document.getElementById("overlayLoading");
  const cancelLoadingBtn = document.getElementById("cancelLoadingBtn");
  const rangeSelect = document.getElementById("rangeSelect");

  let pollingInterval;
  let taskId;
  
  const today = new Date();
  function setStartEnd(daysAgo){
    if (startInput) {
      const start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - daysAgo);
      startInput.value = start.toISOString().substring(0,10);
    }
    if (endInput) {
      endInput.value = today.toISOString().substring(0,10);
    }
  }

  if (rangeSelect) {
      setStartEnd(parseInt(rangeSelect.value));
      rangeSelect.addEventListener("change", ()=> { setStartEnd(parseInt(rangeSelect.value)); });
  }

  // ì‘ì—… ìƒíƒœ í´ë§ í•¨ìˆ˜
  function pollTaskStatus(taskId, successCallback, errorCallback) {
      pollingInterval = setInterval(() => {
          fetch(`/api/krx/task/status?taskId=${taskId}`)
              .then(res => res.json())
              .then(data => {
                  if (data.status === "COMPLETED") {
                      clearInterval(pollingInterval);
                      successCallback(data.result);
                  } else if (data.status === "FAILED") {
                      clearInterval(pollingInterval);
                      errorCallback(new Error(data.error));
                  }
              })
              .catch(err => {
                  clearInterval(pollingInterval);
                  errorCallback(err);
              });
      }, 2000); // 2ì´ˆë§ˆë‹¤ í´ë§
  }

  searchBtn.addEventListener("click", ()=> {
    const start = startInput.value;
    const end = endInput.value;
    const nStocks = nStocksInput.value;

    if(!start || !end){
      warning.textContent = "âš ï¸ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      return;
    }

    if(pollingInterval) clearInterval(pollingInterval);
    
    overlayLoading.style.display="flex";
    warning.textContent="";
    resultTableBody.innerHTML="";
    
    fetch(`/api/krx/last-close-downward/request?start=${start}&end=${end}&topN=${nStocks}`)
      .then(res => {
        if (!res.ok) {
          return res.json().then(errorData => {
            throw new Error(errorData.error);
          });
        }
        return res.json();
      })
      .then(data => {
        taskId = data.taskId;
        pollTaskStatus(taskId, (resultData) => {
          overlayLoading.style.display="none";
          if(!resultData || !Array.isArray(resultData)){
            warning.textContent="ë¶„ì„ ì‹¤íŒ¨ (ì‘ë‹µ ë°ì´í„° ì˜¤ë¥˜)";
            return;
          }
          resultTableBody.innerHTML = '';
          resultData.forEach(item=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${item.ticker || ""}</td><td>${item.name || ""}</td>`;
            tr.addEventListener("click", ()=>{
              chartPopup.style.display="block";
              chartImage.src="";
              chartImage.alt="ì°¨íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

              fetch(`/api/krx/last-close-downward/chart/request?baseSymbol=${item.ticker}&start=${start}&end=${end}`)
                .then(res => {
                  if (!res.ok) {
                    return res.json().then(errorData => {
                      throw new Error(errorData.error);
                    });
                  }
                  return res.json();
                })
                .then(chartTaskData => {
                  pollTaskStatus(chartTaskData.taskId, (chartResult) => {
                    if(chartResult && chartResult.error){
                      chartImage.alt = chartResult.error;
                    } else if(chartResult && chartResult.image_data) {
                      chartImage.src = `data:image/png;base64,${chartResult.image_data}`;
                    } else {
                      chartImage.alt="ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                    }
                  }, (err) => {
                      chartImage.alt="ì°¨íŠ¸ ë¡œë”© ì˜¤ë¥˜: " + err.message; console.error(err);
                  });
                })
                .catch(err=>{ chartImage.alt="ì°¨íŠ¸ ë¡œë”© ì˜¤ë¥˜: " + err.message; console.error(err); });
            });
            resultTableBody.appendChild(tr);
          });
        }, (err) => {
          overlayLoading.style.display="none";
          console.error(err);
          warning.textContent="âš ï¸ " + err.message;
        });
      })
      .catch(err => {
        overlayLoading.style.display="none";
        console.error(err);
        warning.textContent="âš ï¸ " + err.message;
      });
  });

  document.querySelectorAll("[data-close]").forEach(btn=>{
    btn.addEventListener("click", e=>{
      document.getElementById(e.target.dataset.close).style.display="none";
    });
  });

  cancelLoadingBtn.addEventListener("click", ()=>{
    if(pollingInterval) clearInterval(pollingInterval);
    overlayLoading.style.display="none";
    warning.textContent="âš ï¸ ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
  });
});
</script>
</th:block>
</body>
</html>
