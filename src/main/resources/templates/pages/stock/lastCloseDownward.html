<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <title>📊 연속 하락 종목 조회</title>
  <style>
    /* 전체 컨테이너 */
    .content-container { padding: 1rem; box-sizing: border-box; }

    /* 검색 영역 스타일 */
    .search-row { display: flex; flex-wrap: wrap; gap:0.5rem; margin-bottom:0.5rem; align-items:center; }
    .search-row label { margin-right:0.3rem; font-weight:600; }

    /* 입력 필드 스타일 */
    .search-row input[type=date], .search-row input[type=number], .search-row select, .search-row button {
      padding:0.45rem 0.7rem;
      border-radius:6px;
      border:1px solid #ccc;
      box-sizing:border-box;
      flex-shrink:0;
    }

    .search-row input[type=date] { width:120px; min-width:80px; }
    .search-row input[type=number] { width:60px; min-width:50px; }
    .search-row button { cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.3rem; }

    /* 테이블 영역 */
    .table-container { padding-left:0; padding-right:0; margin-top:1rem; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; margin:0; }
    #resultTable tbody tr { border-bottom:1px solid #d1d5db; cursor:pointer; }

    /* 로딩 오버레이 */
    #overlayLoading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
    #overlayLoading .loading-box { background:#fff; padding:1rem 2rem; border-radius:8px; text-align:center; box-shadow:0 0 10px rgba(0,0,0,0.2); }
    #overlayLoading .loading-icon { font-size:2rem; margin-bottom:0.5rem; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    #overlayLoading button { margin-top:0.5rem; padding:0.5rem 1rem; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; }
    #overlayLoading button:disabled { background:#999; cursor:default; }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 연속 하락 종목 조회</h2>

    <!-- 검색 필드 -->
    <div class="search-row">
      <label for="start">시작일</label>
      <input type="date" id="start">
      <label for="end">종료일</label>
      <input type="date" id="end">
      <label for="rangeSelect">기간</label>
      <select id="rangeSelect">
        <option value="7">1주일</option>
        <option value="30" selected>1개월</option>
        <option value="60">2개월</option>
        <option value="90">3개월</option>
        <option value="180">6개월</option>
        <option value="365">1년</option>
      </select>
      <label for="nStocks">상위 N</label>
      <input type="number" id="nStocks" placeholder="10" value="10" max="999">
      <button id="searchBtn"><i class="fas fa-chart-line"></i><span> 분석</span></button>
    </div>

    <div id="warning" style="color:red;font-weight:600;margin-bottom:0.5rem;"></div>

    <!-- 결과 테이블 -->
    <div class="table-container">
      <table id="resultTable">
        <thead>
          <tr>
            <th>종목 코드</th>
            <th>종목명</th>
          </tr>
        </thead>
        <tbody id="resultTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 차트 팝업 -->
  <div class="modal" id="chartPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>유사 종목 차트</h3>
        <span class="close-btn" data-close="chartPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <img id="chartImage" src="" alt="차트 이미지" style="max-width:100%;border-radius:8px;">
      </div>
    </div>
  </div>

  <!-- 로딩 오버레이 -->
  <div id="overlayLoading">
    <div class="loading-box">
      <div class="loading-icon"><i class="fas fa-spinner"></i></div>
      <div>분석 중입니다...</div>
      <button id="cancelLoadingBtn">취소</button>
    </div>
  </div>
</div>

<!-- JS 스크립트 -->
<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", () => {
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const nStocksInput = document.getElementById("nStocks");
  const searchBtn = document.getElementById("searchBtn");
  const warning = document.getElementById("warning");
  const resultTableBody = document.getElementById("resultTableBody");
  const chartPopup = document.getElementById("chartPopup");
  const chartImage = document.getElementById("chartImage");
  const overlayLoading = document.getElementById("overlayLoading");
  const cancelLoadingBtn = document.getElementById("cancelLoadingBtn");
  const rangeSelect = document.getElementById("rangeSelect");

  let currentController = null;

  // 오늘 기준 날짜 세팅
  const today = new Date();
  function setStartEnd(daysAgo){
    const start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - daysAgo);
    startInput.value = start.toISOString().substring(0,10);
    endInput.value = today.toISOString().substring(0,10);
  }
  setStartEnd(parseInt(rangeSelect.value));

  // 기간 select 변경 시 자동 업데이트
  rangeSelect.addEventListener("change", ()=> { setStartEnd(parseInt(rangeSelect.value)); });

  // 분석 버튼 클릭
  searchBtn.addEventListener("click", ()=> {
    const start = startInput.value;
    const end = endInput.value;
    const nStocks = nStocksInput.value;

    if(!start || !end){
      warning.textContent = "⚠️ 시작일과 종료일을 모두 입력해주세요.";
      return;
    }

    // 기존 요청 취소
    if(currentController) currentController.abort();
    currentController = new AbortController();
    const signal = currentController.signal;

    overlayLoading.style.display="flex";
    warning.textContent="";
    resultTableBody.innerHTML="";

    fetch(`/api/krx/last-close-downward?start=${start}&end=${end}&topN=${nStocks}`, {signal})
      .then(res=>res.json())
      .then(data=>{
        overlayLoading.style.display="none";
        currentController = null;

        if(data.error){
          warning.textContent = `⚠️ ${data.error}`;
          return;
        }

        if(!data || !Array.isArray(data.similar_stocks)){
          warning.textContent="분석 실패 (응답 데이터 오류)";
          return;
        }

        data.similar_stocks.forEach(item=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${item.ticker||""}</td><td>${item.name||""}</td>`;
          tr.addEventListener("click", ()=>{
            chartPopup.style.display="block";
            chartImage.src="";
            chartImage.alt="차트 불러오는 중...";

            fetch(`/api/krx/last-close-downward/chart?baseSymbol=${item.ticker}&start=${start}&end=${end}`)
              .then(res=>res.json())
              .then(chartData=>{
                if(chartData.error){
                  chartImage.alt = chartData.error;
                } else if(chartData.image_data) {
                  chartImage.src = `data:image/png;base64,${chartData.image_data}`;
                } else {
                  chartImage.alt="차트 데이터를 불러오지 못했습니다.";
                }
              })
              .catch(err=>{ chartImage.alt="차트 로딩 오류"; console.error(err); });
          });
          resultTableBody.appendChild(tr);
        });
      })
      .catch(err=>{
        overlayLoading.style.display="none";
        currentController=null;
        if(err.name==="AbortError") warning.textContent="⚠️ 분석이 취소되었습니다.";
        else { console.error(err); warning.textContent="서버 오류"; }
      });
  });

  // 차트 팝업 닫기
  document.querySelectorAll("[data-close]").forEach(btn=>{
    btn.addEventListener("click", e=>{
      document.getElementById(e.target.dataset.close).style.display="none";
    });
  });

  // 취소 버튼 클릭
  cancelLoadingBtn.addEventListener("click", ()=>{
    if(currentController) currentController.abort();
    overlayLoading.style.display="none";
  });
});
</script>
</th:block>
</body>
</html>
