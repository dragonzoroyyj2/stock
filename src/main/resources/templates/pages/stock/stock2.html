<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ì‹ ìœ ì‚¬ì¢…ëª© - stock01</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .content-container { max-width:1200px; margin:1rem auto; padding:1rem; }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:1rem; }
    input[type="date"] { padding:6px 8px; border-radius:6px; border:1px solid #ddd; }
    button { padding:6px 10px; border-radius:6px; border: none; background:#2563eb; color:white; cursor:pointer; }
    .chart-wrap { background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.06); height:500px; }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ìœ ì‚¬ ì¢…ëª© ìë™ íƒìƒ‰ (í…ŒìŠ¤íŠ¸)</h2>

    <div class="controls">
      <form id="periodForm" th:action="@{/pages/stock/stock01}" method="get" style="display:flex; gap:8px; align-items:center;">
        ì‹œì‘ì¼:
        <input type="date" name="start" th:value="${startDate}" />
        ì¢…ë£Œì¼:
        <input type="date" name="end" th:value="${endDate}" />
        <button type="submit">ë¶„ì„ ì‹¤í–‰</button>
      </form>
      <div style="margin-left: auto; color:#6b7280;">(í…ŒìŠ¤íŠ¸ìš©: ë¡œì»¬ python/data ì‚¬ìš©)</div>
    </div>

    <div class="chart-wrap">
      <canvas id="stockChart" width="1200" height="480"></canvas>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
  <script th:inline="javascript">
    // Thymeleafì—ì„œ ë„˜ì–´ì˜¨ JSON ë¬¸ìì—´ ë°›ê¸°
    let stockData = /*[[${stockData}]]*/ '[]';
    if (typeof stockData === 'string') {
      try { stockData = JSON.parse(stockData); } catch(e){ stockData = []; }
    }

    // ê¸°ë³¸: ë§Œì•½ ë¹ˆ ë°°ì—´ì´ë©´ ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥
    if (!Array.isArray(stockData) || stockData.length === 0) {
      const ctxEmpty = document.getElementById('stockChart').getContext('2d');
      ctxEmpty.canvas.parentElement.innerHTML = '<div style="padding:30px;color:#6b7280;">ìœ ì‚¬ì¢…ëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Python ìŠ¤í¬ë¦½íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ csvê°€ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</div>';
    } else {
      // ì°¨íŠ¸ ë¼ë²¨(ë‚ ì§œ)ì„ ê°€ì¥ ê¸´ dates(í˜¹ì€ ê¸°ì¤€ ë‚ ì§œ)ë¡œ ì‚¬ìš©
      const labels = stockData[0].dates;

      // datasets ìƒì„±
      const datasets = stockData.map((item, idx) => {
        return {
          label: item.file.replace('.csv','') + ' (ê±°ë¦¬:' + Number(item.distance).toFixed(1) + ')',
          data: item.prices,
          borderColor: `hsl(${(idx*60)%360} 70% 45%)`,
          tension: 0.2,
          fill: false,
          pointRadius: 0
        };
      });

      const ctx = document.getElementById('stockChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'ìœ ì‚¬ ì¢…ëª© ë¹„êµ (ìƒìœ„ ì¢…ëª©)' }
          },
          scales: {
            x: { display: true, ticks: { maxRotation: 45, minRotation: 0 } }
          }
        }
      });
    }
  </script>
</th:block>
</body>
</html>
