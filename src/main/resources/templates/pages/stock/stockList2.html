<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>ì£¼ì‹ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ì£¼ì‹ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h2>

    <!-- ê²€ìƒ‰ -->
    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="íšŒì‚¬ëª…, ì½”ë“œ, ì—…ì¢… ê²€ìƒ‰" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <div class="list-info">
      <span id="totalCount">ì´ 0ê±´</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ"><i class="fa-solid fa-file-excel"></i></button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th>No</th>
          <th>ì¢…ëª©ì½”ë“œ</th>
          <th>íšŒì‚¬ëª…</th>
          <th>ì‹œì¥êµ¬ë¶„</th>
          <th>ì—…ì¢…</th>
          <th>ì¢…ê°€</th>
          <th>ì‹œê°€</th>
          <th>ê³ ê°€</th>
          <th>ì €ê°€</th>
          <th>ê±°ë˜ëŸ‰</th>
          <th>ê¸°ì¤€ì¼</th>
        </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <div id="pagination" class="pagination"></div>
  </div>

  <!-- ìƒì„¸ ëª¨ë‹¬ -->
  <div id="detailModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3 id="modalTitle">ì¢…ëª© ìƒì„¸</h3>
        <span class="close-btn" data-close="detailModal">&times;</span>
      </div>
      <div class="elegant-body">
        <div id="stockInfo"></div>
        <canvas id="stockChart" height="160"></canvas>
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
  <script src="/js/commonPagination_op.js"></script>
  <script src="/js/commonUnifiedList_op.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
    	
        function getPageGroupSize() {
            const width = window.innerWidth;
            if (width < 480) return 3;
            if (width < 768) return 5;
            if (width < 1024) return 10;
            return 20;
          }

          let pageGroupSize = getPageGroupSize();
    	
    	
      initUnifiedList({
        mode: "server",
        pagination: true,
        apiUrl: "/api/stock/list",
        tableBodySelector: "#dataTable",
        paginationSelector: "#pagination",
        searchInputSelector: "#searchInput",
        searchBtnSelector: "#searchBtn",
        excelBtnSelector: "#excelBtn",
        columns: [
          { key: "id", label: "No" },
          { key: "Code", label: "ì¢…ëª©ì½”ë“œ", isDetailLink: true },
          { key: "Name", label: "íšŒì‚¬ëª…" },
          { key: "Market", label: "ì‹œì¥êµ¬ë¶„" },
          { key: "Dept", label: "ì—…ì¢…" },
          { key: "Close", label: "ì¢…ê°€" },
          { key: "Open", label: "ì‹œê°€" },
          { key: "High", label: "ê³ ê°€" },
          { key: "Low", label: "ì €ê°€" },
          { key: "Volume", label: "ê±°ë˜ëŸ‰" },
          { key: "Date", label: "ê¸°ì¤€ì¼" }
        ],
        pageSize: 10,
        pageGroupSize: 10,
        onDetailClick: (row) => openStockDetail(row.Code)
      });
      
      
      // ================================
      // ê²€ìƒ‰ ì—”í„° ì´ë²¤íŠ¸
      // ================================
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      searchInput.addEventListener("keydown", e => {
        if (e.key === "Enter") searchBtn.click();
      });

      // ================================
      // í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ í˜ì´ì§€ ê·¸ë£¹ ì¬ì¡°ì •
      // ================================
      window.addEventListener("resize", () => {
        const newGroupSize = getPageGroupSize();
        if (newGroupSize !== pageGroupSize) {
          pageGroupSize = newGroupSize;
		  
		  // pagination ì¬ë Œë”ë§ ì´ë²¤íŠ¸ í˜¸ì¶œ
          const event = new Event("resizePagination");
          document.dispatchEvent(event);
        }
      });
      
      
    });

    async function openStockDetail(code) {
      const modal = document.getElementById("detailModal");
      const infoDiv = document.getElementById("stockInfo");
      const ctx = document.getElementById("stockChart").getContext("2d");

      const detail = await fetch(`/api/stock/${code}`).then(r => r.json());
      const chartData = await fetch(`/api/stock/${code}/chart`).then(r => r.json());

      infoDiv.innerHTML = `
        <p><strong>${detail.Name}</strong> (${detail.Code})</p>
        <p>ì‹œì¥: ${detail.Market} / ì—…ì¢…: ${detail.Dept}</p>
        <p>ì¢…ê°€: ${Number(detail.Close || 0).toLocaleString()} | ê±°ë˜ëŸ‰: ${Number(detail.Volume || 0).toLocaleString()}</p>
        <p>ê¸°ì¤€ì¼: ${detail.Date}</p>
      `;

      if (window.stockChart) window.stockChart.destroy();

      const labels = chartData.map(d => d.Date);
      const close = chartData.map(d => d.Close);

      window.stockChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "ì¢…ê°€",
            data: close,
            borderColor: "#2563eb",
            backgroundColor: "rgba(37,99,235,0.15)",
            fill: true,
            tension: 0.2
          }]
        },
        options: { scales: { y: { beginAtZero: false } } }
      });

      modal.style.display = "block";
    }
  </script>
</th:block>
</body>
</html>
