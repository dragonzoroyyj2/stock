<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>주식 종목 리스트</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 주식 종목 리스트</h2>

    <!-- 검색 -->
    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="회사명, 코드, 업종 검색" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <div class="list-info">
      <span id="totalCount">총 0건</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel" title="엑셀 다운로드"><i class="fa-solid fa-file-excel"></i></button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th>No</th>
          <th>종목코드</th>
          <th>회사명</th>
          <th>시장구분</th>
          <th>업종</th>
          <th>종가</th>
          <th>시가</th>
          <th>고가</th>
          <th>저가</th>
          <th>거래량</th>
          <th>기준일</th>
        </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <div id="pagination" class="pagination"></div>
  </div>

  <!-- 상세 모달 -->
  <div id="detailModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3 id="modalTitle">종목 상세</h3>
        <span class="close-btn" data-close="detailModal">&times;</span>
      </div>
      <div class="elegant-body">
        <div id="stockInfo"></div>
        <canvas id="stockChart" height="160"></canvas>
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
  <script src="/js/commonPagination_op.js"></script>
  <script src="/js/commonUnifiedList_op.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
    	
        function getPageGroupSize() {
            const width = window.innerWidth;
            if (width < 480) return 3;
            if (width < 768) return 5;
            if (width < 1024) return 10;
            return 20;
          }

          let pageGroupSize = getPageGroupSize();
    	
    	
      initUnifiedList({
        mode: "server",
        pagination: true,
        apiUrl: "/api/stock/list",
        tableBodySelector: "#dataTable",
        paginationSelector: "#pagination",
        searchInputSelector: "#searchInput",
        searchBtnSelector: "#searchBtn",
        excelBtnSelector: "#excelBtn",
        columns: [
          { key: "id", label: "No" },
          { key: "Code", label: "종목코드", isDetailLink: true },
          { key: "Name", label: "회사명" },
          { key: "Market", label: "시장구분" },
          { key: "Dept", label: "업종" },
          { key: "Close", label: "종가" },
          { key: "Open", label: "시가" },
          { key: "High", label: "고가" },
          { key: "Low", label: "저가" },
          { key: "Volume", label: "거래량" },
          { key: "Date", label: "기준일" }
        ],
        pageSize: 10,
        pageGroupSize: 10,
        onDetailClick: (row) => openStockDetail(row.Code)
      });
      
      
      // ================================
      // 검색 엔터 이벤트
      // ================================
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      searchInput.addEventListener("keydown", e => {
        if (e.key === "Enter") searchBtn.click();
      });

      // ================================
      // 화면 리사이즈 시 페이지 그룹 재조정
      // ================================
      window.addEventListener("resize", () => {
        const newGroupSize = getPageGroupSize();
        if (newGroupSize !== pageGroupSize) {
          pageGroupSize = newGroupSize;
		  
		  // pagination 재렌더링 이벤트 호출
          const event = new Event("resizePagination");
          document.dispatchEvent(event);
        }
      });
      
      
    });

    async function openStockDetail(code) {
      const modal = document.getElementById("detailModal");
      const infoDiv = document.getElementById("stockInfo");
      const ctx = document.getElementById("stockChart").getContext("2d");

      const detail = await fetch(`/api/stock/${code}`).then(r => r.json());
      const chartData = await fetch(`/api/stock/${code}/chart`).then(r => r.json());

      infoDiv.innerHTML = `
        <p><strong>${detail.Name}</strong> (${detail.Code})</p>
        <p>시장: ${detail.Market} / 업종: ${detail.Dept}</p>
        <p>종가: ${Number(detail.Close || 0).toLocaleString()} | 거래량: ${Number(detail.Volume || 0).toLocaleString()}</p>
        <p>기준일: ${detail.Date}</p>
      `;

      if (window.stockChart) window.stockChart.destroy();

      const labels = chartData.map(d => d.Date);
      const close = chartData.map(d => d.Close);

      window.stockChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "종가",
            data: close,
            borderColor: "#2563eb",
            backgroundColor: "rgba(37,99,235,0.15)",
            fill: true,
            tension: 0.2
          }]
        },
        options: { scales: { y: { beginAtZero: false } } }
      });

      modal.style.display = "block";
    }
  </script>
</th:block>
</body>
</html>
