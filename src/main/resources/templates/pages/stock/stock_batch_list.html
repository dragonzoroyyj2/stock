<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KRX ì¢…ëª© ì¡°íšŒ</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
	/* ë¡œë”© ì˜¤ë²„ë ˆì´ */
	#overlayLoading {
	    position: fixed;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    background-color: rgba(0, 0, 0, 0.7);
	    display: none;
	    justify-content: center;
	    align-items: center;
	    z-index: 1000;
	}

	.loading-box {
	    background-color: #fff;
	    padding: 30px 50px;
	    border-radius: 10px;
	    text-align: center;
	    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
	    color: #333;
	}

	.loading-icon {
	    font-size: 3rem;
	    animation: pulse 1.5s infinite;
	    margin-bottom: 10px;
	}

	@keyframes pulse {
	    0% { transform: scale(1); }
	    50% { transform: scale(1.1); }
	    100% { transform: scale(1); }
	}

	#cancelLoadingBtn {
	    margin-top: 20px;
	    padding: 8px 16px;
	    border: none;
	    border-radius: 5px;
	    cursor: pointer;
	    background-color: #f44336;
	    color: white;
	}

	/* ìƒíƒœ í‘œì‹œ ë°•ìŠ¤ */
	.status-box {
	    border: 1px solid #ddd;
	    padding: 10px;
	    border-radius: 5px;
	    margin-bottom: 20px;
	}

	.progress-bar-container {
	    width: 100%;
	    background-color: #e0e0e0;
	    border-radius: 5px;
	    margin: 10px 0;
	}

	.progress-bar {
	    height: 10px;
	    background-color: #4caf50;
	    border-radius: 5px;
	    transition: width 0.4s ease;
	}

	.status-message {
	    font-style: italic;
	    color: #666;
	    margin-top: 5px;
	}

	/* í…Œì´ë¸” ë””ìì¸ */
	.table-responsive {
	    overflow-x: auto;
	}

	table {
	    width: 100%;
	    border-collapse: collapse;
	    margin-top: 20px;
	    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
	    background-color: white;
	}

	table thead tr {
	    background-color: #009879;
	    color: #ffffff;
	    text-align: left;
	    font-weight: bold;
	}

	table th, table td {
	    padding: 12px 15px;
	    text-align: left;
	}

	table tbody tr {
	    border-bottom: 1px solid #dddddd;
	}

	table tbody tr:nth-of-type(even) {
	    background-color: #f3f3f3;
	}

	table tbody tr:last-of-type {
	    border-bottom: 2px solid #009879;
	}

	table tbody tr:hover {
	    background-color: #f1f1f1;
	    cursor: pointer;
	}

	/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
	@media screen and (max-width: 600px) {
	    table {
	        border: 0;
	    }
	    table thead {
	        display: none;
	    }
	    table tbody td {
	        display: block;
	        text-align: right;
	    }
	    table tbody td:before {
	        content: attr(data-label);
	        float: left;
	        font-weight: bold;
	    }
	}

	
  </style>
</head>

<body>


	<div layout:fragment="content">
	    <div class="content-container">
	        <h2>ğŸ“Š KRX ìƒì¥ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h2>
	        <div class="status-box">
	            <p>ì—…ë°ì´íŠ¸ ìƒíƒœ: <span id="updateStatus">ëŒ€ê¸° ì¤‘</span></p>
	            <div class="progress-bar-container">
	                <div id="progressBar" class="progress-bar" style="width: 0;"></div>
	            </div>
	            <p id="statusMessage" class="status-message"></p>
	        </div>

	        <div class="toolbar">
	            <input type="text" id="searchInput" placeholder="íšŒì‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰... (ì˜ˆ: ì‚¼ì„±ì „ì)">
	            <button id="updateBtn"><i class="fa-solid fa-rotate"></i> KRX ì—…ë°ì´íŠ¸</button>
	            <button id="refreshBtn"><i class="fa-solid fa-sync-alt"></i> ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
	        </div>

	        <p>ì´ <span id="totalCount">0</span>ê°œ ì¢…ëª©</p>

	        <div class="table-responsive">
	            <table>
	                <thead>
	                    <tr>
	                        <th>ì¢…ëª©ì½”ë“œ</th>
	                        <th>íšŒì‚¬ëª…</th>
	                        <th>ìƒì¥ì¼</th>
	                        <th>ì—…ì¢…</th>
	                        <th>ì£¼ìš”ì œí’ˆ</th>
	                        <th>ëŒ€í‘œì</th>
	                        <th>ì§€ì—­</th>
	                        <th>í™ˆí˜ì´ì§€</th>
	                    </tr>
	                </thead>
	                <tbody id="krxTableBody">
	                    <!-- AJAXë¡œ ë°ì´í„° ì±„ì›Œì§ -->
	                </tbody>
	            </table>
	        </div>
	    </div>
	</div>

	<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
	<div id="overlayLoading" style="display: none;">
	    <div class="loading-box">
	        <div class="loading-icon">âŒ›</div>
	        <div>KRX ì—…ë°ì´íŠ¸ ì¤‘ì…ë‹ˆë‹¤...</div>
	        <button id="cancelLoadingBtn">ì·¨ì†Œ</button>
	    </div>
	</div>

	<th:block layout:fragment="pageScript">
	    <script>
	        document.addEventListener("DOMContentLoaded", () => {
	            let allData = [];
	            let pollingInterval;
	            let currentTaskId = null; // í˜„ì¬ ì‘ì—… ID ì €ì¥

	            // ìš”ì†Œ ì°¸ì¡°ë¥¼ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	            function safeGetElement(id) {
	                const element = document.getElementById(id);
	                if (!element) {
	                    console.error(`Error: Element with id "${id}" not found.`);
	                }
	                return element;
	            }

	            const updateBtn = safeGetElement("updateBtn");
	            const refreshBtn = safeGetElement("refreshBtn");
	            const updateStatusSpan = safeGetElement("updateStatus");
	            const statusMessageP = safeGetElement("statusMessage");
	            const progressBar = safeGetElement("progressBar");
	            const overlayLoading = safeGetElement('overlayLoading');
	            const cancelLoadingBtn = safeGetElement('cancelLoadingBtn');
	            const searchInput = safeGetElement("searchInput");
	            const krxTableBody = safeGetElement("krxTableBody");
	            const totalCountSpan = safeGetElement("totalCount");
	            const taskIdStorageKey = "stockUpdateTaskId";

	            // âœ… í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
	            function renderTable(data) {
	                if (!krxTableBody || !totalCountSpan) {
	                    console.error("í…Œì´ë¸” ë Œë”ë§ì— í•„ìš”í•œ DOM ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
	                    return;
	                }
	                krxTableBody.innerHTML = "";
	                totalCountSpan.textContent = data.length;

	                data.forEach(item => {
	                    const tr = document.createElement("tr");
	                    // JSON ë°ì´í„°ì˜ í‚¤ì™€ HTML í•„ë“œë¥¼ ì •í™•í•˜ê²Œ ì¼ì¹˜ì‹œí‚´
	                    tr.innerHTML = `
	                        <td data-label="ì¢…ëª©ì½”ë“œ">${item.Symbol || ''}</td>
	                        <td data-label="íšŒì‚¬ëª…">${item.Name || ''}</td>
	                        <td data-label="ìƒì¥ì¼">${item.ListingDate || ''}</td>
	                        <td data-label="ì—…ì¢…">${item.Sector || ''}</td>
	                        <td data-label="ì£¼ìš”ì œí’ˆ">${item.Product || ''}</td>
	                        <td data-label="ëŒ€í‘œì">${item.Representative || ''}</td>
	                        <td data-label="ì§€ì—­">${item.Region || ''}</td>
	                        <td data-label="í™ˆí˜ì´ì§€">
	                            <a href="${item.Homepage || '#'}" target="_blank">${item.Homepage || ''}</a>
	                        </td>
	                    `;
	                    krxTableBody.appendChild(tr);
	                });
	            }

	            // âœ… ì „ì²´ ì¢…ëª© ëª©ë¡ì„ ê°€ì ¸ì™€ í…Œì´ë¸” ê°±ì‹ 
	            function fetchStockList() {
	                fetch("/batch/stock-list")
	                    .then(res => {
	                        if (!res.ok) {
	                            throw new Error(`HTTP error! status: ${res.status}`);
	                        }
	                        return res.json();
	                    })
	                    .then(data => {
	                        if (data && data.status === "success" && data.stock_list) {
	                            allData = data.stock_list;
	                            renderTable(allData);
	                        } else {
	                            console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", data.error);
	                            renderTable([]);
	                        }
	                    })
	                    .catch(err => {
	                        console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
	                        renderTable([]);
	                    });
	            }

	            // âœ… KRX ì—…ë°ì´íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ í˜¸ì¶œ
	            if (updateBtn) {
	                updateBtn.addEventListener("click", () => {
	                    updateBtn.disabled = true;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> ì—…ë°ì´íŠ¸ ì¤‘...";
	                    if (overlayLoading) overlayLoading.style.display = 'flex';
	                    if (statusMessageP) statusMessageP.textContent = "KRX ì—…ë°ì´íŠ¸ ë°°ì¹˜ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...";

	                    fetch("/batch/stock/update/start", { method: "POST" })
	                        .then(res => res.json())
	                        .then(data => {
	                            if (data.taskId) {
	                                currentTaskId = data.taskId;
	                                localStorage.setItem(taskIdStorageKey, data.taskId);
	                                startPolling(data.taskId);
	                            } else {
	                                handleError("KRX ì—…ë°ì´íŠ¸ ì‹œì‘ ì‹¤íŒ¨: ì‘ì—… ID ì—†ìŒ");
	                            }
	                        })
	                        .catch(err => {
	                            handleError("KRX ì—…ë°ì´íŠ¸ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
	                        });
	                });
	            }

	            // âœ… ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‘ì—… ì·¨ì†Œ
	            if (cancelLoadingBtn) {
	                cancelLoadingBtn.addEventListener("click", () => {
	                    clearInterval(pollingInterval);
	                    localStorage.removeItem(taskIdStorageKey);
	                    currentTaskId = null;
	                    if (updateStatusSpan) updateStatusSpan.textContent = "ì·¨ì†Œë¨";
	                    if (statusMessageP) statusMessageP.textContent = "ì‚¬ìš©ìê°€ ì‘ì—…ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.";
	                    if (progressBar) progressBar.style.width = "0%";
	                    if (overlayLoading) overlayLoading.style.display = 'none';
	                    if (updateBtn) {
	                        updateBtn.disabled = false;
	                        updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX ì—…ë°ì´íŠ¸";
	                    }
	                });
	            }

	            // âœ… ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œ ëª©ë¡ ê°±ì‹ 
	            if (refreshBtn) {
	                refreshBtn.addEventListener("click", fetchStockList);
	            }

	            // âœ… íšŒì‚¬ëª… ê²€ìƒ‰ í•„í„°
	            if (searchInput) {
	                searchInput.addEventListener("input", (e) => {
	                    const keyword = e.target.value.trim().toLowerCase();
	                    const filtered = allData.filter(item =>
	                        item.Name && item.Name.toLowerCase().includes(keyword)
	                    );
	                    renderTable(filtered);
	                });
	            }

	            // âœ… ìƒíƒœ í´ë§ ì‹œì‘
	            function startPolling(taskId) {
	                if (updateStatusSpan) updateStatusSpan.textContent = "ì§„í–‰ ì¤‘...";
	                if (progressBar) progressBar.style.width = "50%"; // ì„ì‹œ ì§„í–‰ë¥ 

	                if (pollingInterval) clearInterval(pollingInterval);

	                pollingInterval = setInterval(() => {
	                    fetch(`/batch/task/status/${taskId}`)
	                        .then(res => res.json())
	                        .then(taskStatus => {
	                            if (taskStatus.status === "COMPLETED") {
	                                handleCompletion(taskStatus);
	                            } else if (taskStatus.status === "FAILED") {
	                                handleFailure(taskStatus);
	                            } else {
	                                // IN_PROGRESS ìƒíƒœ
	                                if (statusMessageP) statusMessageP.textContent = "ì‘ì—… ì§„í–‰ ì¤‘...";
	                            }
	                        })
	                        .catch(err => {
	                            handleError("ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
	                        });
	                }, 3000); // 3ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
	            }

	            // âœ… ì‘ì—… ì™„ë£Œ ì²˜ë¦¬
	            function handleCompletion(taskStatus) {
	                clearInterval(pollingInterval);
	                localStorage.removeItem(taskIdStorageKey);
	                currentTaskId = null;
	                if (updateStatusSpan) updateStatusSpan.textContent = "ì™„ë£Œ";
	                if (statusMessageP) statusMessageP.textContent = `KRX ì—…ë°ì´íŠ¸ ì™„ë£Œ. ì´ ${taskStatus.result.count}ê°œ ì¢…ëª©.`;
	                if (progressBar) progressBar.style.width = "100%";
	                if (overlayLoading) overlayLoading.style.display = 'none';
	                if (updateBtn) {
	                    updateBtn.disabled = false;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX ì—…ë°ì´íŠ¸";
	                }
	                fetchStockList(); // ì™„ë£Œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
	            }

	            // âœ… ì‘ì—… ì‹¤íŒ¨ ì²˜ë¦¬
	            function handleFailure(taskStatus) {
	                clearInterval(pollingInterval);
	                localStorage.removeItem(taskIdStorageKey);
	                currentTaskId = null;
	                if (updateStatusSpan) updateStatusSpan.textContent = "ì‹¤íŒ¨";
	                if (statusMessageP) statusMessageP.textContent = `KRX ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${taskStatus.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
	                if (progressBar) progressBar.style.width = "0%";
	                if (overlayLoading) overlayLoading.style.display = 'none';
	                if (updateBtn) {
	                    updateBtn.disabled = false;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX ì—…ë°ì´íŠ¸";
	                }
	            }

	            // âœ… ì˜¤ë¥˜ ì²˜ë¦¬
	            function handleError(message) {
	                if (pollingInterval) clearInterval(pollingInterval);
	                localStorage.removeItem(taskIdStorageKey);
	                currentTaskId = null;
	                if (updateBtn) {
	                    updateBtn.disabled = false;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX ì—…ë°ì´íŠ¸";
	                }
	                if (updateStatusSpan) updateStatusSpan.textContent = "ì˜¤ë¥˜";
	                if (statusMessageP) statusMessageP.textContent = message;
	                console.error(message);
	                if (overlayLoading) overlayLoading.style.display = 'none';
	            }

	            // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í™•ì¸
	            fetchStockList();
	            const storedTaskId = localStorage.getItem(taskIdStorageKey);
	            if (storedTaskId) {
	                currentTaskId = storedTaskId;
	                startPolling(storedTaskId);
	                if (updateBtn) {
	                    updateBtn.disabled = true;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> ì—…ë°ì´íŠ¸ ì¤‘...";
	                }
	                if (statusMessageP) statusMessageP.textContent = "ì´ì „ ì‘ì—…ì˜ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...";
	                if (overlayLoading) overlayLoading.style.display = 'flex'; // ì´ì „ ì‘ì—…ì´ ìˆì—ˆë‹¤ë©´ ë¡œë”©ì°½ í‘œì‹œ
	            }
	        });
	    </script>
	</th:block>






</body>
</html>
