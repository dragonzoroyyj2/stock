<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KRX 종목 조회</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
	/* 로딩 오버레이 */
	#overlayLoading {
	    position: fixed;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    background-color: rgba(0, 0, 0, 0.7);
	    display: none;
	    justify-content: center;
	    align-items: center;
	    z-index: 1000;
	}

	.loading-box {
	    background-color: #fff;
	    padding: 30px 50px;
	    border-radius: 10px;
	    text-align: center;
	    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
	    color: #333;
	}

	.loading-icon {
	    font-size: 3rem;
	    animation: pulse 1.5s infinite;
	    margin-bottom: 10px;
	}

	@keyframes pulse {
	    0% { transform: scale(1); }
	    50% { transform: scale(1.1); }
	    100% { transform: scale(1); }
	}

	#cancelLoadingBtn {
	    margin-top: 20px;
	    padding: 8px 16px;
	    border: none;
	    border-radius: 5px;
	    cursor: pointer;
	    background-color: #f44336;
	    color: white;
	}

	/* 상태 표시 박스 */
	.status-box {
	    border: 1px solid #ddd;
	    padding: 10px;
	    border-radius: 5px;
	    margin-bottom: 20px;
	}

	.progress-bar-container {
	    width: 100%;
	    background-color: #e0e0e0;
	    border-radius: 5px;
	    margin: 10px 0;
	}

	.progress-bar {
	    height: 10px;
	    background-color: #4caf50;
	    border-radius: 5px;
	    transition: width 0.4s ease;
	}

	.status-message {
	    font-style: italic;
	    color: #666;
	    margin-top: 5px;
	}

	/* 테이블 디자인 */
	.table-responsive {
	    overflow-x: auto;
	}

	table {
	    width: 100%;
	    border-collapse: collapse;
	    margin-top: 20px;
	    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
	    background-color: white;
	}

	table thead tr {
	    background-color: #009879;
	    color: #ffffff;
	    text-align: left;
	    font-weight: bold;
	}

	table th, table td {
	    padding: 12px 15px;
	    text-align: left;
	}

	table tbody tr {
	    border-bottom: 1px solid #dddddd;
	}

	table tbody tr:nth-of-type(even) {
	    background-color: #f3f3f3;
	}

	table tbody tr:last-of-type {
	    border-bottom: 2px solid #009879;
	}

	table tbody tr:hover {
	    background-color: #f1f1f1;
	    cursor: pointer;
	}

	/* 모바일 반응형 */
	@media screen and (max-width: 600px) {
	    table {
	        border: 0;
	    }
	    table thead {
	        display: none;
	    }
	    table tbody td {
	        display: block;
	        text-align: right;
	    }
	    table tbody td:before {
	        content: attr(data-label);
	        float: left;
	        font-weight: bold;
	    }
	}

	
  </style>
</head>

<body>


	<div layout:fragment="content">
	    <div class="content-container">
	        <h2>📊 KRX 상장 종목 리스트</h2>
	        <div class="status-box">
	            <p>업데이트 상태: <span id="updateStatus">대기 중</span></p>
	            <div class="progress-bar-container">
	                <div id="progressBar" class="progress-bar" style="width: 0;"></div>
	            </div>
	            <p id="statusMessage" class="status-message"></p>
	        </div>

	        <div class="toolbar">
	            <input type="text" id="searchInput" placeholder="회사명으로 검색... (예: 삼성전자)">
	            <button id="updateBtn"><i class="fa-solid fa-rotate"></i> KRX 업데이트</button>
	            <button id="refreshBtn"><i class="fa-solid fa-sync-alt"></i> 목록 새로고침</button>
	        </div>

	        <p>총 <span id="totalCount">0</span>개 종목</p>

	        <div class="table-responsive">
	            <table>
	                <thead>
	                    <tr>
	                        <th>종목코드</th>
	                        <th>회사명</th>
	                        <th>상장일</th>
	                        <th>업종</th>
	                        <th>주요제품</th>
	                        <th>대표자</th>
	                        <th>지역</th>
	                        <th>홈페이지</th>
	                    </tr>
	                </thead>
	                <tbody id="krxTableBody">
	                    <!-- AJAX로 데이터 채워짐 -->
	                </tbody>
	            </table>
	        </div>
	    </div>
	</div>

	<!-- 로딩 오버레이 -->
	<div id="overlayLoading" style="display: none;">
	    <div class="loading-box">
	        <div class="loading-icon">⌛</div>
	        <div>KRX 업데이트 중입니다...</div>
	        <button id="cancelLoadingBtn">취소</button>
	    </div>
	</div>

	<th:block layout:fragment="pageScript">
	    <script>
	        document.addEventListener("DOMContentLoaded", () => {
	            let allData = [];
	            let pollingInterval;
	            let currentTaskId = null; // 현재 작업 ID 저장

	            // 요소 참조를 안전하게 가져오는 함수
	            function safeGetElement(id) {
	                const element = document.getElementById(id);
	                if (!element) {
	                    console.error(`Error: Element with id "${id}" not found.`);
	                }
	                return element;
	            }

	            const updateBtn = safeGetElement("updateBtn");
	            const refreshBtn = safeGetElement("refreshBtn");
	            const updateStatusSpan = safeGetElement("updateStatus");
	            const statusMessageP = safeGetElement("statusMessage");
	            const progressBar = safeGetElement("progressBar");
	            const overlayLoading = safeGetElement('overlayLoading');
	            const cancelLoadingBtn = safeGetElement('cancelLoadingBtn');
	            const searchInput = safeGetElement("searchInput");
	            const krxTableBody = safeGetElement("krxTableBody");
	            const totalCountSpan = safeGetElement("totalCount");
	            const taskIdStorageKey = "stockUpdateTaskId";

	            // ✅ 테이블 렌더링 함수
	            function renderTable(data) {
	                if (!krxTableBody || !totalCountSpan) {
	                    console.error("테이블 렌더링에 필요한 DOM 요소가 없습니다.");
	                    return;
	                }
	                krxTableBody.innerHTML = "";
	                totalCountSpan.textContent = data.length;

	                data.forEach(item => {
	                    const tr = document.createElement("tr");
	                    // JSON 데이터의 키와 HTML 필드를 정확하게 일치시킴
	                    tr.innerHTML = `
	                        <td data-label="종목코드">${item.Symbol || ''}</td>
	                        <td data-label="회사명">${item.Name || ''}</td>
	                        <td data-label="상장일">${item.ListingDate || ''}</td>
	                        <td data-label="업종">${item.Sector || ''}</td>
	                        <td data-label="주요제품">${item.Product || ''}</td>
	                        <td data-label="대표자">${item.Representative || ''}</td>
	                        <td data-label="지역">${item.Region || ''}</td>
	                        <td data-label="홈페이지">
	                            <a href="${item.Homepage || '#'}" target="_blank">${item.Homepage || ''}</a>
	                        </td>
	                    `;
	                    krxTableBody.appendChild(tr);
	                });
	            }

	            // ✅ 전체 종목 목록을 가져와 테이블 갱신
	            function fetchStockList() {
	                fetch("/batch/stock-list")
	                    .then(res => {
	                        if (!res.ok) {
	                            throw new Error(`HTTP error! status: ${res.status}`);
	                        }
	                        return res.json();
	                    })
	                    .then(data => {
	                        if (data && data.status === "success" && data.stock_list) {
	                            allData = data.stock_list;
	                            renderTable(allData);
	                        } else {
	                            console.error("데이터 불러오기 실패:", data.error);
	                            renderTable([]);
	                        }
	                    })
	                    .catch(err => {
	                        console.error("데이터 불러오기 중 오류 발생:", err);
	                        renderTable([]);
	                    });
	            }

	            // ✅ KRX 업데이트 버튼 클릭 시 서버 호출
	            if (updateBtn) {
	                updateBtn.addEventListener("click", () => {
	                    updateBtn.disabled = true;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 업데이트 중...";
	                    if (overlayLoading) overlayLoading.style.display = 'flex';
	                    if (statusMessageP) statusMessageP.textContent = "KRX 업데이트 배치 작업을 시작합니다...";

	                    fetch("/batch/stock/update/start", { method: "POST" })
	                        .then(res => res.json())
	                        .then(data => {
	                            if (data.taskId) {
	                                currentTaskId = data.taskId;
	                                localStorage.setItem(taskIdStorageKey, data.taskId);
	                                startPolling(data.taskId);
	                            } else {
	                                handleError("KRX 업데이트 시작 실패: 작업 ID 없음");
	                            }
	                        })
	                        .catch(err => {
	                            handleError("KRX 업데이트 시작 중 오류 발생");
	                        });
	                });
	            }

	            // ✅ 취소 버튼 클릭 시 작업 취소
	            if (cancelLoadingBtn) {
	                cancelLoadingBtn.addEventListener("click", () => {
	                    clearInterval(pollingInterval);
	                    localStorage.removeItem(taskIdStorageKey);
	                    currentTaskId = null;
	                    if (updateStatusSpan) updateStatusSpan.textContent = "취소됨";
	                    if (statusMessageP) statusMessageP.textContent = "사용자가 작업을 취소했습니다.";
	                    if (progressBar) progressBar.style.width = "0%";
	                    if (overlayLoading) overlayLoading.style.display = 'none';
	                    if (updateBtn) {
	                        updateBtn.disabled = false;
	                        updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX 업데이트";
	                    }
	                });
	            }

	            // ✅ 새로고침 버튼 클릭 시 목록 갱신
	            if (refreshBtn) {
	                refreshBtn.addEventListener("click", fetchStockList);
	            }

	            // ✅ 회사명 검색 필터
	            if (searchInput) {
	                searchInput.addEventListener("input", (e) => {
	                    const keyword = e.target.value.trim().toLowerCase();
	                    const filtered = allData.filter(item =>
	                        item.Name && item.Name.toLowerCase().includes(keyword)
	                    );
	                    renderTable(filtered);
	                });
	            }

	            // ✅ 상태 폴링 시작
	            function startPolling(taskId) {
	                if (updateStatusSpan) updateStatusSpan.textContent = "진행 중...";
	                if (progressBar) progressBar.style.width = "50%"; // 임시 진행률

	                if (pollingInterval) clearInterval(pollingInterval);

	                pollingInterval = setInterval(() => {
	                    fetch(`/batch/task/status/${taskId}`)
	                        .then(res => res.json())
	                        .then(taskStatus => {
	                            if (taskStatus.status === "COMPLETED") {
	                                handleCompletion(taskStatus);
	                            } else if (taskStatus.status === "FAILED") {
	                                handleFailure(taskStatus);
	                            } else {
	                                // IN_PROGRESS 상태
	                                if (statusMessageP) statusMessageP.textContent = "작업 진행 중...";
	                            }
	                        })
	                        .catch(err => {
	                            handleError("상태 조회 중 오류 발생");
	                        });
	                }, 3000); // 3초마다 상태 확인
	            }

	            // ✅ 작업 완료 처리
	            function handleCompletion(taskStatus) {
	                clearInterval(pollingInterval);
	                localStorage.removeItem(taskIdStorageKey);
	                currentTaskId = null;
	                if (updateStatusSpan) updateStatusSpan.textContent = "완료";
	                if (statusMessageP) statusMessageP.textContent = `KRX 업데이트 완료. 총 ${taskStatus.result.count}개 종목.`;
	                if (progressBar) progressBar.style.width = "100%";
	                if (overlayLoading) overlayLoading.style.display = 'none';
	                if (updateBtn) {
	                    updateBtn.disabled = false;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX 업데이트";
	                }
	                fetchStockList(); // 완료 후 목록 새로고침
	            }

	            // ✅ 작업 실패 처리
	            function handleFailure(taskStatus) {
	                clearInterval(pollingInterval);
	                localStorage.removeItem(taskIdStorageKey);
	                currentTaskId = null;
	                if (updateStatusSpan) updateStatusSpan.textContent = "실패";
	                if (statusMessageP) statusMessageP.textContent = `KRX 업데이트 실패: ${taskStatus.error || '알 수 없는 오류'}`;
	                if (progressBar) progressBar.style.width = "0%";
	                if (overlayLoading) overlayLoading.style.display = 'none';
	                if (updateBtn) {
	                    updateBtn.disabled = false;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX 업데이트";
	                }
	            }

	            // ✅ 오류 처리
	            function handleError(message) {
	                if (pollingInterval) clearInterval(pollingInterval);
	                localStorage.removeItem(taskIdStorageKey);
	                currentTaskId = null;
	                if (updateBtn) {
	                    updateBtn.disabled = false;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-rotate'></i> KRX 업데이트";
	                }
	                if (updateStatusSpan) updateStatusSpan.textContent = "오류";
	                if (statusMessageP) statusMessageP.textContent = message;
	                console.error(message);
	                if (overlayLoading) overlayLoading.style.display = 'none';
	            }

	            // ✅ 페이지 로드 시 초기 상태 확인
	            fetchStockList();
	            const storedTaskId = localStorage.getItem(taskIdStorageKey);
	            if (storedTaskId) {
	                currentTaskId = storedTaskId;
	                startPolling(storedTaskId);
	                if (updateBtn) {
	                    updateBtn.disabled = true;
	                    updateBtn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 업데이트 중...";
	                }
	                if (statusMessageP) statusMessageP.textContent = "이전 작업의 상태를 확인 중입니다...";
	                if (overlayLoading) overlayLoading.style.display = 'flex'; // 이전 작업이 있었다면 로딩창 표시
	            }
	        });
	    </script>
	</th:block>






</body>
</html>
