<div id="stockLayerPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
     width:90%; max-width:1200px; max-height:80%; background:#fff; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);
     overflow:auto; z-index:1000; padding:1rem; font-family:'Noto Sans KR',Arial,sans-serif;">

  <!-- ë ˆì´ì–´ í—¤ë” -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
    <h3 style="margin:0; font-size:1.1rem;">ğŸ“Š KRX ìƒì¥ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h3>
    <button id="closeLayerBtn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
  </div>

  <!-- ê²€ìƒ‰ ë°” -->
  <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;">
    <input type="text" id="searchInputLayer" placeholder="íšŒì‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰..." style="flex:1; min-width:150px; padding:0.5rem; border:1px solid #ccc; border-radius:5px;">
    <button id="fetchBtnLayer" style="padding:0.5rem 1rem; background:#3b82f6; color:#fff; border:none; border-radius:5px; cursor:pointer;">ì¡°íšŒ</button>
  </div>

  <!-- ì¢…ëª© í…Œì´ë¸” -->
  <div style="overflow:auto;">
    <table id="krxLayerTable" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#f3f4f6; font-weight:600;">
          <th style="padding:0.5rem; border-bottom:1px solid #ddd;">ì¢…ëª©ì½”ë“œ</th>
          <th style="padding:0.5rem; border-bottom:1px solid #ddd;">íšŒì‚¬ëª…</th>
          <th style="padding:0.5rem; border-bottom:1px solid #ddd;">ì—…ì¢…</th>
          <th style="padding:0.5rem; border-bottom:1px solid #ddd;">ëŒ€í‘œì</th>
        </tr>
      </thead>
      <tbody id="krxLayerBody"></tbody>
    </table>
  </div>
</div>

<!-- ë ˆì´ì–´ ë°°ê²½ -->
<div id="layerBackdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.5); z-index:999;"></div>

<script>
let krxDataLayer = [];

// ë ˆì´ì–´ ì—´ê¸° í•¨ìˆ˜
function openStockLayerPopup() {
  document.getElementById('stockLayerPopup').style.display = 'block';
  document.getElementById('layerBackdrop').style.display = 'block';
}

// ë ˆì´ì–´ ë‹«ê¸° í•¨ìˆ˜
document.getElementById('closeLayerBtn').addEventListener('click', () => {
  document.getElementById('stockLayerPopup').style.display = 'none';
  document.getElementById('layerBackdrop').style.display = 'none';
});

// ë°°ê²½ í´ë¦­ ì‹œ ë ˆì´ì–´ ë‹«ê¸°
document.getElementById('layerBackdrop').addEventListener('click', () => {
  document.getElementById('stockLayerPopup').style.display = 'none';
  document.getElementById('layerBackdrop').style.display = 'none';
});

// í…Œì´ë¸” ë Œë”ë§
function renderLayerTable(data) {
  const tbody = document.getElementById('krxLayerBody');
  tbody.innerHTML = '';
  data.forEach(item => {
    const tr = document.createElement('tr');
    tr.style.cursor = 'pointer';
    tr.innerHTML = `
      <td style="padding:0.5rem; border-bottom:1px solid #ddd;">${item.code}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #ddd;">${item.name}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #ddd;">${item.sector || ''}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #ddd;">${item.ceo || ''}</td>
    `;
    // í´ë¦­ ì‹œ ë¶€ëª¨ ì°½ inputìœ¼ë¡œ ê°’ ì „ë‹¬
    tr.addEventListener('click', () => {
      const companyInput = document.getElementById('company');
      const companyCodeInput = document.getElementById('companyCode');
      if(companyInput && companyCodeInput){
        companyInput.value = item.name;
        companyCodeInput.value = item.code;
      }
      document.getElementById('stockLayerPopup').style.display = 'none';
      document.getElementById('layerBackdrop').style.display = 'none';
    });
    tbody.appendChild(tr);
  });
}

// KRX ì¡°íšŒ
document.getElementById('fetchBtnLayer').addEventListener('click', () => {
  const btn = document.getElementById('fetchBtnLayer');
  btn.disabled = true;
  btn.textContent = 'ì¡°íšŒ ì¤‘...';

  fetch('/api/krx')  // ì„œë²„ì—ì„œ JSON ë°ì´í„° ë°›ê¸°
    .then(res => res.json())
    .then(data => {
      krxDataLayer = data;
      renderLayerTable(data);
      btn.disabled = false;
      btn.textContent = 'ì¡°íšŒ';
    })
    .catch(err => {
      console.error(err);
      btn.disabled = false;
      btn.textContent = 'ì¡°íšŒ';
      alert('ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    });
});

// íšŒì‚¬ëª… ê²€ìƒ‰
document.getElementById('searchInputLayer').addEventListener('input', (e) => {
  const keyword = e.target.value.trim().toLowerCase();
  const filtered = krxDataLayer.filter(item => item.name.toLowerCase().includes(keyword));
  renderLayerTable(filtered);
});
</script>
