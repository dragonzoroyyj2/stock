<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š KRX ì°¨íŠ¸ íŒ¨í„´ ì¡°íšŒ</title>
  <link rel="stylesheet" th:href="@{/css/commonStock.css}" href="/css/commonStock.css">
</head>
<body>
<div layout:fragment="content">
  <div class="content-container">
    <h1>KRX ì°¨íŠ¸ íŒ¨í„´ ì¡°íšŒ</h1>

    <div class="search-row">
      <label for="patternSelect">íŒ¨í„´ ì¢…ë¥˜:</label>
      <select id="patternSelect">
        <option value="head_and_shoulders">í—¤ë“œì•¤ìˆ„ë”</option>
        <option value="inverse_head_and_shoulders">ì—­í—¤ë“œì•¤ìˆ„ë”</option>
        <option value="double_top">ì´ì¤‘ ì²œì •</option>
        <option value="double_bottom">ì´ì¤‘ ë°”ë‹¥</option>
        <option value="cup_and_handle">ì»µì•¤í•¸ë“¤</option>
      </select>

      <label for="rangeSelectPattern">ê¸°ê°„ ì„ íƒ:</label>
      <select id="rangeSelectPattern">
        <option value="30" selected>1ê°œì›”</option>
        <option value="90">3ê°œì›”</option>
        <option value="180">6ê°œì›”</option>
        <option value="365">1ë…„</option>
        <option value="730">2ë…„</option>
      </select>

      <label for="startPattern">ì‹œì‘ì¼:</label>
      <input type="date" id="startPattern" required>
      <label for="endPattern">ì¢…ë£Œì¼:</label>
      <input type="date" id="endPattern" required>

      <label for="nStocksPattern">ìƒìœ„ Nê°œ:</label>
      <input type="number" id="nStocksPattern" value="10" min="1" max="50">

      <button id="searchBtnPattern" class="btn">ë¶„ì„ ì‹œì‘</button>
    </div>

    <div id="warningPattern" class="warning"></div>

    <div class="table-container">
      <table id="resultTablePattern">
        <thead>
        <tr><th>ì¢…ëª© ì½”ë“œ</th><th>ì¢…ëª©ëª…</th><th>íŒ¨í„´</th></tr>
        </thead>
        <tbody id="resultTableBodyPattern"></tbody>
      </table>
    </div>

    <!-- íŒì—… (ì°¨íŠ¸/ë‰´ìŠ¤) ê·¸ëŒ€ë¡œ ìœ ì§€ -->
    <div class="modal" id="chartPopup">
      <div class="elegant-modal">
        <div class="elegant-header">
          <h3>ì¢…ëª© ìƒì„¸ ì •ë³´</h3>
          <span class="close-btn" data-close="chartPopup">&times;</span>
        </div>
        <div class="elegant-body">
          <div class="tabs">
            <button class="tab-btn active" data-tab="chart-content">ì°¨íŠ¸</button>
            <button class="tab-btn" data-tab="news-content">ë‰´ìŠ¤/ê³µì‹œ</button>
          </div>
          <div id="chart-content" class="tab-content active">
            <img id="chartImage" src="" alt="ì°¨íŠ¸ ì´ë¯¸ì§€" style="max-width:100%;border-radius:8px;">
          </div>
          <div id="news-content" class="tab-content">
            <ul id="newsList"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="overlayLoading">
      <div class="loading-box">
        <div class="loading-icon">âŒ›</div>
        <div>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
        <button id="cancelLoadingBtn">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>
</div>


<th:block layout:fragment="pageScript">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const rangeSelect = document.getElementById('rangeSelectPattern');
      const startInput = document.getElementById('startPattern');
      const endInput = document.getElementById('endPattern');
      const searchBtn = document.getElementById('searchBtnPattern');
      const overlay = document.getElementById('overlayLoading');
      const cancelBtn = document.getElementById('cancelLoadingBtn');
      const warning = document.getElementById('warningPattern');
      const tbody = document.getElementById('resultTableBodyPattern');

      let currentTaskId = null;
      let pollTimer = null;

      // ===== ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (1ê°œì›”)
      function setInitialDates(days = 30) {
        const today = new Date();
        const past = new Date();
        past.setDate(today.getDate() - days);
        endInput.value = formatDate(today);
        startInput.value = formatDate(past);
      }
      function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }
      setInitialDates(30);
      rangeSelect.addEventListener('change', (e) => setInitialDates(parseInt(e.target.value, 10)));

      // ===== ë¶„ì„ ì‹œì‘
      searchBtn.addEventListener('click', async () => {
        const start = startInput.value;
        const end = endInput.value;
        const pattern = document.getElementById('patternSelect').value;
        const topN = document.getElementById('nStocksPattern').value;

        if (!start || !end || !pattern || !topN) {
          displayMsg('âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }

        displayMsg('âŒ› ë¶„ì„ ìš”ì²­ ì¤‘...', 'info');
        overlay.style.display = 'flex';

        try {
          const formData = new URLSearchParams();
          formData.append('start', start);
          formData.append('end', end);
          formData.append('pattern', pattern);
          formData.append('topN', topN);

          const response = await fetch('/chart/patterns/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData
          });

          const data = await response.json();

          // âœ… ì„ ì  í: ë‹¤ë¥¸ ìœ ì €ê°€ ì‹¤í–‰ ì¤‘ì¼ ë•Œ (409)
          if (response.status === 409) {
            overlay.style.display = 'none';
            displayMsg(data.message || 'ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            return;
          }

          if (!response.ok) {
            throw new Error(data.message || 'ìš”ì²­ ì‹¤íŒ¨');
          }

          if (!data.taskId) {
            throw new Error('taskId ëˆ„ë½');
          }

          currentTaskId = data.taskId;
          displayMsg('âœ”ï¸ ë¶„ì„ ìš”ì²­ ì„±ê³µ. ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'success');
          startPolling(currentTaskId);
        } catch (err) {
          overlay.style.display = 'none';
          displayMsg(`âš ï¸ ìš”ì²­ ì‹¤íŒ¨: ${err.message}`, 'error');
        }
      });

      // ===== ìƒíƒœ í´ë§
      function startPolling(taskId) {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(async () => {
          try {
            const res = await fetch(`/chart/task/status/${taskId}`);
            if (!res.ok) throw new Error('ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨');
            const data = await res.json();

            switch (data.status) {
              case 'COMPLETED':
                clearInterval(pollTimer);
                overlay.style.display = 'none';
                displayMsg('âœ”ï¸ ë¶„ì„ ì™„ë£Œ', 'success');
                renderResults(data.result);
                currentTaskId = null;
                break;
              case 'FAILED':
                clearInterval(pollTimer);
                overlay.style.display = 'none';
                displayMsg(`âŒ ì‹¤íŒ¨: ${data.errorMessage || 'ë¶„ì„ ì‹¤íŒ¨'}`, 'error');
                currentTaskId = null;
                break;
              case 'CANCELLED':
                clearInterval(pollTimer);
                overlay.style.display = 'none';
                displayMsg('ğŸ›‘ ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                currentTaskId = null;
                break;
              case 'RUNNING':
                displayMsg('â³ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...', 'info');
                break;
              case 'WAITING':
                displayMsg('âŒ› ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...', 'info');
                break;
              default:
                displayMsg('â³ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
                break;
            }
          } catch (e) {
            clearInterval(pollTimer);
            overlay.style.display = 'none';
            displayMsg(`âš ï¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${e.message}`, 'error');
            currentTaskId = null;
          }
        }, 1500);
      }

      // ===== ì·¨ì†Œ ë²„íŠ¼
      cancelBtn.addEventListener('click', async () => {
        try {
          if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
          }
          if (currentTaskId) {
            await fetch(`/chart/task/cancel/${currentTaskId}`, {method: 'POST'});
          }
          overlay.style.display = 'none';
          displayMsg('ğŸ›‘ ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
          currentTaskId = null;
        } catch (e) {
          overlay.style.display = 'none';
          displayMsg(`âš ï¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜: ${e.message}`, 'error');
        }
      });

      // ===== ê²°ê³¼ ë Œë”ë§
      function renderResults(results) {
        tbody.innerHTML = '';
        if (!results || results.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3">ê²°ê³¼ ì—†ìŒ</td></tr>';
          return;
        }
        results.forEach(r => {
          const row = document.createElement('tr');
          const patterns = Array.isArray(r.patterns) ? r.patterns.join(', ') : r.patterns;
          row.innerHTML = `<td>${r.symbol}</td><td>${r.name}</td><td>${patterns}</td>`;
          tbody.appendChild(row);
        });
      }

      // ===== ë©”ì‹œì§€ í‘œì‹œ
      function displayMsg(msg, type) {
        warning.innerText = msg;
        warning.className =
          type === 'success'
            ? 'msg-success'
            : type === 'error'
              ? 'msg-error'
              : 'msg-info';
      }
    });
  </script>
</th:block>



</body>
</html>
